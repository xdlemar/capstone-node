generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Supplier {
  id             BigInt          @id @default(autoincrement())
  name           String          @unique
  contact        String?
  rating         Int? // 1â€“5 manual for now
  purchaseOrders PurchaseOrder[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PurchaseRequest {
  id          BigInt    @id @default(autoincrement())
  requesterId BigInt
  status      String    @default("PENDING") // PENDING | APPROVED | REJECTED | CONVERTED
  neededBy    DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  items PRItem[]
}

model PRItem {
  id      BigInt  @id @default(autoincrement())
  prId    BigInt
  itemSku String
  qty     Decimal

  pr PurchaseRequest @relation(fields: [prId], references: [id], onDelete: Cascade)
}

model PurchaseOrder {
  id         BigInt   @id @default(autoincrement())
  supplierId BigInt
  prId       BigInt?
  status     String   @default("OPEN") // OPEN | PARTIAL | RECEIVED | CLOSED | CANCELLED
  approvedBy BigInt?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  supplier Supplier  @relation(fields: [supplierId], references: [id], onDelete: Restrict)
  items    POItem[]
  receipts Receipt[]
}

model POItem {
  id      BigInt  @id @default(autoincrement())
  poId    BigInt
  itemSku String
  qty     Decimal
  price   Decimal @default(0)

  po           PurchaseOrder @relation(fields: [poId], references: [id], onDelete: Cascade)
  receiptItems ReceiptItem[]
}

model Receipt {
  id         BigInt   @id @default(autoincrement())
  poId       BigInt
  receivedBy BigInt
  receivedAt DateTime @default(now())

  po    PurchaseOrder @relation(fields: [poId], references: [id], onDelete: Cascade)
  lines ReceiptItem[]
  files FileObject[]
}

model ReceiptItem {
  id          BigInt  @id @default(autoincrement())
  receiptId   BigInt
  poItemId    BigInt
  qtyReceived Decimal

  receipt Receipt @relation(fields: [receiptId], references: [id], onDelete: Cascade)
  poItem  POItem  @relation(fields: [poItemId], references: [id], onDelete: Restrict)
}

model FileObject {
  id         BigInt   @id @default(autoincrement())
  receiptId  BigInt?
  name       String
  mimeType   String
  sizeBytes  Int
  storageKey String // S3/local path
  checksum   String
  createdAt  DateTime @default(now())

  receipt Receipt? @relation(fields: [receiptId], references: [id], onDelete: SetNull)
}
